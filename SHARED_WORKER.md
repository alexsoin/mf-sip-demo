# Документация: SharedWorker и Архитектура Синхронизации

## Обзор
В проекте SIP-Phone Widget используется технология **SharedWorker** для обеспечения синхронизации состояния между несколькими вкладками браузера. Это позволяет пользователю открыть виджет в нескольких окнах, при этом звонок, статус оператора и соединение с сервером будут едиными для всех вкладок.

## Зачем нужен SharedWorker?
Обычный код JavaScript (включая компоненты Vue) выполняется изолированно в каждой вкладке. Без SharedWorker каждая вкладка создавала бы свое собственное подключение к серверу (SSE/WebSocket). Это привело бы к:
1.  **Дублированию соединений**: 10 вкладок = 10 подключений к серверу.
2.  **Рассинхронизации**: Звонок мог бы прийти в одну вкладку, но не отобразиться в другой сразу.
3.  **Конфликтам**: При попытке ответить на звонок в одной вкладке, другие могли бы не узнать об этом вовремя.

**SharedWorker** решает эти проблемы, создавая **единый поток**, который работает в фоне и обслуживает все вкладки одного источника (origin).

## Архитектура

### 1. Центральный Хаб (SharedWorker)
Файл: `src/sip-worker.js`

*   **Singleton SSE Connection**: Воркере устанавливает **единственное** SSE-соединение с бэкендом (`/api/sip/events`).
*   **Управление Состоянием (Global Store)**: Воркере хранит "Истинное состояние" (Master State):
    *   `connectionStatus`: статус подключения к серверу.
    *   `operatorStatus`: статус оператора (Ready, DND, etc.).
    *   `activeCall`: информация о текущем звонке.
*   **Реестр Портов**: Воркере хранит список всех подключенных портов (вкладок) в `Set<MessagePort>`.

### 2. Клиент (Vue Component)
Файл: `src/components/SipPhoneWidget.ce.vue`

*   Каждый экземпляр виджета при монтировании подключается к SharedWorker.
*   Виджет работает в режиме **"Slave"** (Ведомый). Он не хранит состояние сам по себе, а лишь отображает то, что прислал воркер.
*   **Pinia Store** (`src/store.ts`) используется как реактивный кэш на клиенте. Он обновляется исключительно по команде `SYNC_STATE` от воркера.

## Протокол Взаимодействия

Общение происходит через механизм `postMessage`.

### От Воркера к Вкладкам (Broadcast)

Воркер рассылает сообщения всем подключенным портам при любом изменении состояния.

*   **`SYNC_STATE`**: Полная синхронизация состояния.
    ```json
    {
      "type": "SYNC_STATE",
      "payload": {
        "connectionStatus": "connected",
        "operatorStatus": "ready",
        "activeCall": { ... }
      }
    }
    ```

### От Вкладок к Воркеру (Commands)

Вкладки отправляют команды (Intent) на изменение состояния или действия. Вкладка **никогда** не меняет свое состояние локально (кроме оптимистичных обновлений интерфейса, ожидая подтверждения).

1.  **`INIT_PORT`**: Первое сообщение при подключении. В ответ воркер шлет текущий `SYNC_STATE`.
2.  **`CMD_DIAL`**: Инициировать звонок.
    ```json
    { "type": "CMD_DIAL", "payload": { "phone": "123456" } }
    ```
    *Воркер делает POST-запрос на API и рассылает всем вкладкам обновление статуса "dialing".*
3.  **`CMD_ANSWER`**: Ответить на звонок.
4.  **`CMD_HANGUP`**: Завершить звонок.
5.  **`CMD_STATUS`**: Изменить статус оператора.

## Жизненный Цикл

1.  **Запуск приложения**:
    *   Пользователь открывает Вкладку A.
    *   Создается SharedWorker (если еще не создан).
    *   Воркер подключается к SSE.
    *   Воркер шлет `SYNC_STATE` во Вкладку A.

2.  **Открытие второй вкладки**:
    *   Пользователь открывает Вкладку B.
    *   Браузер переиспользует тот же запущенный SharedWorker.
    *   Вкладка B посылает `INIT_PORT`.
    *   Воркер шлет текущий `SYNC_STATE` во Вкладку B (оно уже синхронизировано с А).

3.  **Входящее событие (SSE)**:
    *   Сервер присылает событие `call_incoming`.
    *   Воркер обновляет `globalState`.
    *   Воркер делает `broadcast()` всем портам.
    *   Вкладка A и Вкладка B одновременно отображают входящий звонок.

4.  **Действие пользователя**:
    *   Пользователь нажимает "Ответить" во Вкладке A.
    *   Вкладка A шлет `CMD_ANSWER` воркеру.
    *   Воркер делает запрос к API.
    *   Воркер обновляет состояние звонка на "talking".
    *   Воркер рассылает `SYNC_STATE`.
    *   Вкладка B (и А) обновляют UI на "Разговор".

## Обработка Ошибок

*   **SSE Error**: Если соединение с сервером падает, воркер меняет статус на `reconnecting` и пробует переподключиться каждые 5 секунд. Статус транслируется всем вкладкам, и они показывают желтый индикатор.
*   **API Error**: Если POST-запрос не прошел (например, `CMD_DIAL`), ошибка пишется в консоль воркера. В реальном приложении можно добавить событие `ERROR` для уведомления пользователя.
